name: Job Scraping Pipeline

on:
  # ... (igual)

env:
  # ... (igual)

jobs:
  scrape-and-process:
    name: ðŸ” Coleta e Processamento
    runs-on: ubuntu-latest
    
    steps:
      # ... (steps 1 a 10 iguais)

      # 11. Envia notificaÃ§Ãµes Telegram (adicionado debug e tratamento melhor)
      - name: Send Telegram Notifications
        if: ${{ github.event.inputs.dry_run != 'true' }}
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          echo "ðŸ“² Enviando notificaÃ§Ãµes..."
          # Adiciona try-catch no Python para capturar erros e nÃ£o falhar o job
          python -c "
          import sys
          import os
          import httpx  # Assumindo que httpx estÃ¡ instalado; se nÃ£o, adicione no install
          
          try:
              from src.pipeline import notify  # Ajuste se for um mÃ³dulo diferente
              notify()  # Ou chame a funÃ§Ã£o especÃ­fica
              print('âœ… NotificaÃ§Ãµes enviadas com sucesso')
          except Exception as e:
              print(f'âš ï¸ Erro ao enviar notificaÃ§Ãµes: {e}', file=sys.stderr)
              sys.exit(0)  # Sai com 0 para nÃ£o falhar o job (use continue-on-error se preferir falhar)
          "
        continue-on-error: true  # MantÃ©m, mas agora o erro nÃ£o crasha

      # 11.1 NOVO: Garante que .seen_jobs.json exista antes de salvar cache
      - name: Ensure seen_jobs file exists
        if: always()
        run: |
          mkdir -p data/
          if [ ! -f data/.seen_jobs.json ]; then
            echo '{"seen_jobs": []}' > data/.seen_jobs.json
            echo "ðŸ“ Arquivo .seen_jobs.json criado vazio"
          else
            echo "ðŸ“‚ Arquivo .seen_jobs.json jÃ¡ existe"
          fi
          cat data/.seen_jobs.json  # Debug: mostra conteÃºdo

      # 12. Salvar cache de vagas vistas (corrigido com save-always)
      - name: Save seen jobs cache
        if: always()
        uses: actions/cache/save@v4
        with:
          path: data/.seen_jobs.json
          key: seen-jobs-${{ github.run_number }}
          save-always: true  # ForÃ§a save mesmo em falhas (disponÃ­vel no v4)

      # ... (steps 13 a 15 iguais, mas adicione isso no Summary para mais info)
      
      # No step 15 (Summary), adicione esta linha extra para debug de cache:
      # ApÃ³s as contagens, adicione:
      # echo "- Cache Seen Jobs: $( [ -f data/.seen_jobs.json ] && echo 'Existe' || echo 'Ausente' )" >> $GITHUB_STEP_SUMMARY
