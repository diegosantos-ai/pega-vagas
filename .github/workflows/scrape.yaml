name: Job Scraping Pipeline - Every 3 Hours

on:
  # ExecuÃ§Ã£o agendada: a cada 3 horas
  # 0 0,3,6,9,12,15,18,21 * * * = 00:00, 03:00, 06:00, 09:00, 12:00, 15:00, 18:00, 21:00 UTC
  # Convertendo para BRT (UTC-3): 21:00, 00:00, 03:00, 06:00, 09:00, 12:00, 15:00, 18:00 BRT
  schedule:
    - cron: '0 0,3,6,9,12,15,18,21 * * *'  # A cada 3 horas em UTC
  
  # Permite execuÃ§Ã£o manual
  workflow_dispatch:
    inputs:
      query:
        description: 'Termo de busca (ex: Data Engineer)'
        required: false
        default: 'Data Engineer'
      max_jobs:
        description: 'NÃºmero mÃ¡ximo de vagas'
        required: false
        default: '100'
      dry_run:
        description: 'Modo dry-run (sem enviar notificaÃ§Ãµes)'
        required: false
        default: 'false'

env:
  PYTHON_VERSION: '3.11'
  TZ: 'America/Sao_Paulo'

jobs:
  scrape-and-process:
    runs-on: ubuntu-latest
    
    steps:
      # 1. Checkout do cÃ³digo
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Setup Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      # 3. Cache do Playwright/Camoufox
      - name: Cache Playwright browsers
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ hashFiles('pyproject.toml') }}

      # 4. Instala dependÃªncias
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
          pip install pyyaml  # Para carregar config.yaml
          playwright install firefox

      # 5. Executa scraping (Bronze) - MÃºltiplos termos
      - name: Run Bronze Layer (Scraping)
        env:
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          PROXY_URL: ${{ secrets.PROXY_URL }}
        run: |
          # Busca por mÃºltiplos termos para aumentar volume
          python -m src.pipeline bronze --query "Data Engineer" --max-jobs 50
          python -m src.pipeline bronze --query "Automation Engineer" --max-jobs 30
          python -m src.pipeline bronze --query "AI Engineer" --max-jobs 30
          python -m src.pipeline bronze --query "Data Analyst" --max-jobs 30
        continue-on-error: true

      # 6. Executa processamento LLM (Silver)
      - name: Run Silver Layer (LLM Processing)
        env:
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
        run: |
          python -m src.pipeline silver
        continue-on-error: true

      # 7. Executa transformaÃ§Ãµes (Gold)
      - name: Run Gold Layer (DuckDB Transform)
        run: |
          python -m src.pipeline gold
        continue-on-error: true

      # 8. Exporta para Parquet
      - name: Export to Parquet
        run: |
          python -m src.pipeline export
        continue-on-error: true

      # 9. Envia notificaÃ§Ãµes Telegram
      - name: Send Telegram Notifications
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          # Modo dry-run se especificado
          if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            echo "DRY_RUN=true" >> $GITHUB_ENV
          fi
          python -m src.pipeline notify
        continue-on-error: true

      # 10. Upload de artefatos (para debug)
      - name: Upload Bronze artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bronze-data-${{ github.run_number }}
          path: data/bronze/
          retention-days: 7

      # 11. Upload de dados processados
      - name: Upload Gold artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gold-data-${{ github.run_number }}
          path: data/gold/
          retention-days: 30

      # 12. NotificaÃ§Ã£o de sucesso/falha
      - name: Send notification on failure
        if: failure()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          # Envia alerta de falha
          python -c "
          import os
          import requests
          
          token = os.getenv('TELEGRAM_BOT_TOKEN')
          chat_id = os.getenv('TELEGRAM_CHAT_ID')
          
          if token and chat_id:
              message = 'âš ï¸ Pipeline de vagas falhou! Verifique os logs.'
              url = f'https://api.telegram.org/bot{token}/sendMessage'
              requests.post(url, json={'chat_id': chat_id, 'text': message})
          "
        continue-on-error: true

      # 13. Resumo da execuÃ§Ã£o
      - name: Summary
        if: always()
        run: |
          echo "## ðŸ“Š Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ” Termos de Busca: Data Engineer, Automation Engineer, AI Engineer, Data Analyst" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“ Max Jobs: 140 total" >> $GITHUB_STEP_SUMMARY
          echo "- â° ExecuÃ§Ã£o: $(date '+%Y-%m-%d %H:%M:%S %Z')" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”„ FrequÃªncia: A cada 3 horas" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“ Timezone: America/Sao_Paulo (BRT)" >> $GITHUB_STEP_SUMMARY
