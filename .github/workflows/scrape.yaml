name: Job Scraping Pipeline

on:
  # ExecuÃ§Ã£o agendada: a cada 3 horas
  schedule:
    - cron: '0 0,3,6,9,12,15,18,21 * * *'
  
  # Permite execuÃ§Ã£o manual
  workflow_dispatch:
    inputs:
      query:
        description: 'Termo de busca (ex: Data Engineer)'
        required: false
        default: 'Data Engineer'
      max_jobs:
        description: 'NÃºmero mÃ¡ximo de vagas por termo'
        required: false
        default: '50'
      platform:
        description: 'Plataforma (all, api, greenhouse, gupy-api)'
        required: false
        default: 'api'
      dry_run:
        description: 'Modo dry-run (sem enviar notificaÃ§Ãµes)'
        required: false
        type: boolean
        default: false

env:
  PYTHON_VERSION: '3.11'
  TZ: 'America/Sao_Paulo'

jobs:
  scrape-and-process:
    name: ðŸ” Coleta e Processamento
    runs-on: ubuntu-latest
    
    steps:
      # 1. Checkout do cÃ³digo
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Setup Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      # 3. Cache de dependÃªncias e dados
      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: pip-${{ runner.os }}-${{ hashFiles('pyproject.toml') }}
          restore-keys: |
            pip-${{ runner.os }}-

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ hashFiles('pyproject.toml') }}

      # 4. Restaurar cache de vagas notificadas
      - name: Restore seen jobs cache
        uses: actions/cache@v4
        with:
          path: data/.seen_jobs.json
          key: seen-jobs-${{ github.run_number }}
          restore-keys: |
            seen-jobs-

      # 5. Instala dependÃªncias
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
          pip install pyyaml
          playwright install firefox

      # 6. VerificaÃ§Ã£o de saÃºde
      - name: Health check
        env:
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          echo "ðŸ” Verificando configuraÃ§Ã£o..."
          python -c "
          import os
          import sys
          
          errors = []
          
          if not os.getenv('GOOGLE_API_KEY'):
              errors.append('GOOGLE_API_KEY nÃ£o configurado')
          
          if not os.getenv('TELEGRAM_BOT_TOKEN'):
              errors.append('TELEGRAM_BOT_TOKEN nÃ£o configurado')
          
          if not os.getenv('TELEGRAM_CHAT_ID'):
              errors.append('TELEGRAM_CHAT_ID nÃ£o configurado')
          
          if errors:
              print('âŒ Erros de configuraÃ§Ã£o:')
              for e in errors:
                  print(f'  - {e}')
              sys.exit(1)
          
          print('âœ… ConfiguraÃ§Ã£o OK')
          "

      # 7. Executa scraping (Bronze)
      - name: Run Bronze Layer (Scraping)
        env:
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          PROXY_URL: ${{ secrets.PROXY_URL }}
        run: |
          echo "ðŸ“¥ Iniciando coleta de vagas..."
          
          # Busca mÃºltiplos termos
          python -m src.pipeline bronze --query "Data Engineer" --max-jobs ${{ github.event.inputs.max_jobs || '50' }} --platform ${{ github.event.inputs.platform || 'api' }}
          python -m src.pipeline bronze --query "Analytics Engineer" --max-jobs 30 --platform ${{ github.event.inputs.platform || 'api' }}
          python -m src.pipeline bronze --query "Data Analyst" --max-jobs 30 --platform ${{ github.event.inputs.platform || 'api' }}
          python -m src.pipeline bronze --query "AI Engineer" --max-jobs 20 --platform ${{ github.event.inputs.platform || 'api' }}
          
          echo "ðŸ“Š Arquivos coletados:"
          find data/bronze -name "*.json" 2>/dev/null | wc -l || echo "0"
        continue-on-error: true

      # 8. Executa processamento LLM (Silver)
      - name: Run Silver Layer (LLM Processing)
        env:
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
        run: |
          echo "ðŸ¤– Processando com LLM..."
          python -m src.pipeline silver
          
          echo "ðŸ“Š Arquivos processados:"
          find data/silver -name "*_processed.json" 2>/dev/null | wc -l || echo "0"
        continue-on-error: true

      # 9. Executa transformaÃ§Ãµes (Gold)
      - name: Run Gold Layer (DuckDB Transform)
        run: |
          echo "ðŸ’Ž Gerando camada Gold..."
          python -m src.pipeline gold
        continue-on-error: true

      # 10. Exporta para Parquet
      - name: Export to Parquet
        run: |
          echo "ðŸ“¦ Exportando para Parquet..."
          python -m src.pipeline export
        continue-on-error: true

      # 11. Envia notificaÃ§Ãµes Telegram
      - name: Send Telegram Notifications
        if: ${{ github.event.inputs.dry_run != 'true' }}
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          echo "ðŸ“² Enviando notificaÃ§Ãµes..."
          python -m src.pipeline notify
        continue-on-error: true

      # 12. Salvar cache de vagas vistas
      - name: Save seen jobs cache
        if: always()
        uses: actions/cache/save@v4
        with:
          path: data/.seen_jobs.json
          key: seen-jobs-${{ github.run_number }}

      # 13. Upload de artefatos (para debug)
      - name: Upload Bronze artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bronze-data-${{ github.run_number }}
          path: data/bronze/
          retention-days: 3
          if-no-files-found: ignore

      - name: Upload Silver artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: silver-data-${{ github.run_number }}
          path: data/silver/
          retention-days: 3
          if-no-files-found: ignore

      - name: Upload Gold artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gold-data-${{ github.run_number }}
          path: data/gold/
          retention-days: 7
          if-no-files-found: ignore

      # 14. NotificaÃ§Ã£o de falha
      - name: Send failure notification
        if: failure()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          python -c "
          import os
          import httpx
          
          token = os.getenv('TELEGRAM_BOT_TOKEN')
          chat_id = os.getenv('TELEGRAM_CHAT_ID')
          
          if token and chat_id:
              message = 'âš ï¸ *Pipeline de vagas falhou!*\n\nVerifique os logs: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}'
              url = f'https://api.telegram.org/bot{token}/sendMessage'
              httpx.post(url, json={'chat_id': chat_id, 'text': message, 'parse_mode': 'Markdown'})
          "
        continue-on-error: true

      # 15. Resumo da execuÃ§Ã£o
      - name: Summary
        if: always()
        run: |
          echo "## ðŸ“Š Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| MÃ©trica | Valor |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ” Termos de Busca | Data Engineer, Analytics Engineer, Data Analyst, AI Engineer |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“ Max Jobs/Termo | ${{ github.event.inputs.max_jobs || '50' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”Œ Plataforma | ${{ github.event.inputs.platform || 'api' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| â° ExecuÃ§Ã£o | $(date '+%Y-%m-%d %H:%M:%S %Z') |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”„ Modo | ${{ github.event.inputs.dry_run == 'true' && 'Dry Run' || 'ProduÃ§Ã£o' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Contagem de arquivos
          BRONZE_COUNT=$(find data/bronze -name "*.json" 2>/dev/null | wc -l || echo "0")
          SILVER_COUNT=$(find data/silver -name "*_processed.json" 2>/dev/null | wc -l || echo "0")
          
          echo "### ðŸ“ˆ Resultados" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Bronze (coletadas): $BRONZE_COUNT" >> $GITHUB_STEP_SUMMARY
          echo "- Silver (processadas): $SILVER_COUNT" >> $GITHUB_STEP_SUMMARY
